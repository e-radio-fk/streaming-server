<html>
<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
	<meta content="utf-8" http-equiv="encoding">	

    <title>FK Live E-Radio: Control Panel</title>
    <link rel="stylesheet" href="css/main.css">
    
	<!-- Firebase -->
	<script defer src="https://www.gstatic.com/firebasejs/8.1.2/firebase-app.js"></script>
	<script defer src="https://www.gstatic.com/firebasejs/8.1.2/firebase-auth.js"></script>

	<!-- Initialise Firebase -->
	<script defer src="scripts/Firebase/init-firebase.js"></script>

    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
</head>
<header style="visibility: hidden;">
    <div class="now-playing-banner" id="control-panel-nav-bar" style="position: relative;">
        <h4 style="position: absolute;" id="control-panel-nav-bar-title">Console&emsp;version 0.0.0.2</h4>
        <div class="dropdown">
            <div class="dropdown-content">
              <a href="./settings.html">Settings</a>
              <a onclick="sign_out()" id="console-sign-out-button">Sign Out</a>
            </div>
            <img class="dropbtn" id="banner-user-img" onclick="toggle_login_dropdown()">
        </div>
    </div>

    <!-- This is for the login dropdown -->
    <script>
        var login_button = document.getElementById('banner-user-img');
        var dropdown_content = document.getElementsByClassName('dropdown-content')[0];

        function toggle_login_dropdown() 
        {
            var clicked = login_button.getAttribute('clicked');
            if (clicked == 'yes')
            {
                login_button.setAttribute('clicked', 'no');
                dropdown_content.style.display = 'none';
            }
            else
            {
                login_button.setAttribute('clicked', 'yes');
                dropdown_content.style.display = 'block';
            }
        }
    </script>

    <script defer src="scripts/login.js"></script>
    <script defer src="scripts/console.js"></script>
</header>
<body style="visibility: hidden;">
    <br>
    <br>
    <button id="console-toggle-microphone" onclick="toggle_mic()">start mic</button>

    <h3>Playlists</h3>
    <button>(+) import yt playlist</button>

    <!-- Chat space -->
	<div id="live-chat-container">
		<yt-live-chat-renderer>
			<yt-live-chat-item-list-renderer>
			</yt-live-chat-item-list-renderer>
		</yt-live-chat-renderer>
		<input type="text" class="yt-live-chat-message-box" id="live-chat-message-box">
	
        <script src="scripts/livechat.js"></script>
    </div>

    <!-- Note: this is mainly for darkmode -->
    <script src="scripts/darkmode.js"></script>
    <script src="scripts/general.js"></script>
    <script src="https://cdn.socket.io/3.1.3/socket.io.min.js" integrity="sha384-cPwlPLvBTa3sKAgddT6krw0cJat7egBga3DJepJyrLl4Q9/5WLra3rrnMcyTyOnh" crossorigin="anonymous"></script>
    <script>
        // let shouldStop = false;
        // let stopped = false;

        const socket = io.connect('/');

        // microphone
        const _options = {mimeType: 'audio/webm'};
        const recordedChunks = [];
        var mediaRecorder = null;

        /* get microphone button handle */
        var microphoneButton = document.getElementById('console-toggle-microphone');
        microphoneButton.setAttribute('on', 'no');

        /* initialise mic streaming capability */
        navigator.mediaDevices.getUserMedia({ audio: true, video: false }).then(stream => {
            mediaRecorder = new MediaRecorder(stream, _options);
            if (!mediaRecorder)
            {
                show_error('Error: Failure creating a mediaRecorder; Reload page!', '...');
                return;
            }
            
            mediaRecorder.addEventListener('dataavailable', function(e) {
                if (e.data.size > 0)
                {
                    recordedChunks.push(e.data);
                }
            });

            mediaRecorder.addEventListener('stop', function() {
                // console.log('got: ', recordedChunks);
                socket.emit('console-mic-chunks', recordedChunks);
            });
        })
        .catch(function(err) {
            show_error('Error: Microphone access has been denied probably!', '...');
        });

        function toggle_mic() {
            if (microphoneButton.getAttribute('on') == 'yes')
            {
                record_mic_stop();
                microphoneButton.setAttribute('on', 'no');
                microphoneButton.innerHTML = 'start mic';
            }
            else if (microphoneButton.getAttribute('on') == 'no') 
            {
                record_mic_start();
                microphoneButton.setAttribute('on', 'yes');
                microphoneButton.innerHTML = 'stop mic';
            }
        }

        function record_mic_start() 
        {
            mediaRecorder.start();
        }
        function record_mic_stop() 
        {
            mediaRecorder.stop();
        }
    </script>
</body>
</html>